{# Smart 智能模式 OpenClash 覆写配置模板 #}
{# ============================================================================ #}
{# 配置名称: {{ config_name }} #}
{# 配置类型: Smart 智能模式 #}
{# Provider 数量: {{ provider_count }} #}
{# ============================================================================ #}

[General]
CONFIG_FILE = /etc/openclash/config/{{ config_name }}.yaml
CORE_TYPE = Smart

# DNS
ENABLE_REDIRECT_DNS = 1
APPEND_WAN_DNS = 1
STORE_FAKEIP = 1
CUSTOM_FAKEIP_FILTER = 1
CUSTOM_FAKEIP_FILTER_MODE = blacklist
FAKEIP_RANGE = 198.18.0.1/16

# IPv6
IPV6_ENABLE = 1
IPV6_DNS = 1
ENABLE_V6_UDP_PROXY = 1

# 代理模式
EN_MODE = fake-ip
ENABLE_UDP_PROXY = 1
ROUTER_SELF_PROXY = 1
PROXY_MODE = rule

# Smart 模式特有
AUTO_SMART_SWITCH = 1
SMART_STRATEGY = sticky-sessions
SMART_ENABLE_LGBM = 0
SMART_POLICY_PRIORITY = Premium:0.9;SG:1.3;HK:1.5
SMART_COLLECT = 1
SMART_COLLECT_SIZE = 500
SMART_COLLECT_RATE = 1

# 订阅信息
{% if provider_count == 1 %}
SUB_INFO_URL = $EN_KEY
{% else %}
{%- for env_var in env_variables %}
SUB_INFO_URL{{ loop.index }} = ${{ env_var }}
{%- endfor %}
{% endif %}

# 下载精简后的 YAML
DOWNLOAD_FILE = url={{ yaml_download_url }}, path=/etc/openclash/config/{{ config_name }}.yaml, cron=0 6 * * *, force=true

RESTART = true

# 覆写规则
[Overwrite]
{% if provider_count == 1 %}
ruby_edit "$CONFIG_FILE" "['proxy-providers']['{{ proxy_providers[0].name }}']['url']" "$EN_KEY"
{% else %}
{%- for provider in proxy_providers %}
ruby_edit "$CONFIG_FILE" "['proxy-providers']['{{ provider.name }}']['url']" "$EN_KEY{{ loop.index }}"
{%- endfor %}
{% endif %}
