# ==========================================================
# OpenClash 覆写配置文件 - 旁路由模式
# 来源: {{ source_type }} / {{ config_name }}
# Provider数量: {{ provider_count }}
# 注意: 必须设置 EN_DNS 环境变量
# ==========================================================

[General]
CORE_TYPE = Meta
CONFIG_FILE = /etc/openclash/config/{{ config_name }}.yaml

# DNS 设置（旁路由模式）
ENABLE_REDIRECT_DNS = 1
APPEND_WAN_DNS = 1
STORE_FAKEIP = 1
CUSTOM_FAKEIP_FILTER = 1
CUSTOM_FAKEIP_FILTER_MODE = blacklist
FAKEIP_RANGE = 198.18.0.1/16

# IPv6
IPV6_ENABLE = 1
IPV6_DNS = 1
ENABLE_V6_UDP_PROXY = 1

# 代理模式
EN_MODE = fake-ip
ENABLE_UDP_PROXY = 1
ROUTER_SELF_PROXY = 1
PROXY_MODE = rule

# 旁路由特有
INTRANET_ALLOWED = 0
BYPASS_GATEWAY_COMPATIBLE = 1

# 订阅信息
{% if provider_count == 1 %}
SUB_INFO_URL = $EN_KEY
{% else %}
{% for i in range(1, provider_count + 1) %}
SUB_INFO_URL{{ i }} = $EN_KEY{{ i }}
{% endfor %}
{% endif %}

# 下载配置
DOWNLOAD_FILE = url={{ yaml_url }}, path=/etc/openclash/config/{{ config_name }}.yaml, cron=0 6 * * *, force=true

RESTART = true

[Overwrite]
# 更新订阅链接
{% if provider_count == 1 %}
ruby_edit "$CONFIG_FILE" "['proxy-providers']['{{ proxy_providers[0].name }}']['url']" "$EN_KEY"
{% else %}
{% for provider in proxy_providers %}
ruby_edit "$CONFIG_FILE" "['proxy-providers']['{{ provider.name }}']['url']" "$EN_KEY{{ loop.index }}"
{% endfor %}
{% endif %}

# 旁路由必须设置 DNS
ruby_edit "$CONFIG_FILE" "['dns']['nameserver']" "$EN_DNS"
