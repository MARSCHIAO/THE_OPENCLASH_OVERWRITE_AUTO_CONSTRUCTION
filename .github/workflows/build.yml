name: Build OpenClash Overwrites

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'  # æ¯å¤©æ—©6ç‚¹è‡ªåŠ¨æ›´æ–°
  push:
    branches: [main]
    paths:
      - 'cleaner_config/**'
      - 'templates/**'
      - 'src/**'
      - '.github/workflows/**'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jinja2

      - name: Fetch External Configs (HenryChiao)
        run: |
          echo "ðŸ“¥ Fetching external configs..."
          mkdir -p raw_configs/external
          git clone --depth=1 https://github.com/HenryChiao/mihomo_yamls.git /tmp/upstream
          
          if [ -d "/tmp/upstream/THEYAMLS/General_Config" ]; then
            cp -r /tmp/upstream/THEYAMLS/General_Config raw_configs/external/
            echo "âœ… General_Config copied"
          fi
          
          if [ -d "/tmp/upstream/THEYAMLS/Smart_Mode" ]; then
            cp -r /tmp/upstream/THEYAMLS/Smart_Mode raw_configs/external/
            echo "âœ… Smart_Mode copied"
          fi
          
          count=$(find raw_configs/external -name "*.yaml" | wc -l)
          echo "ðŸ“Š Found $count external YAML files"

      - name: Copy Local Configs
        run: |
          echo "ðŸ“‚ Copying local configs..."
          mkdir -p raw_configs/local
          if [ -d "cleaner_config" ] && [ "$(ls -A cleaner_config 2>/dev/null)" ]; then
            cp -r cleaner_config/* raw_configs/local/
            echo "âœ… Local configs copied"
          else
            echo "â„¹ï¸ No local configs found, skipping..."
          fi

      - name: Process YAML configs
        run: |
          echo "ðŸ”§ Processing YAML configs..."
          mkdir -p processed_configs/external processed_configs/local
          
          # å¤„ç†å¤–éƒ¨é…ç½®
          if [ -d "raw_configs/external" ] && [ "$(find raw_configs/external -name '*.yaml' | wc -l)" -gt 0 ]; then
            python src/yaml_processor.py \
              --input raw_configs/external \
              --output processed_configs/external \
              --recursive \
              --verbose
          fi
          
          # å¤„ç†æœ¬åœ°é…ç½®
          if [ -d "raw_configs/local" ] && [ "$(find raw_configs/local -name '*.yaml' | wc -l)" -gt 0 ]; then
            python src/yaml_processor.py \
              --input raw_configs/local \
              --output processed_configs/local \
              --recursive \
              --verbose
          fi

      - name: Generate Overwrite Files
        run: |
          echo "ðŸ“ Generating overwrite files..."
          mkdir -p overwrite
          
          REPO_URL="https://raw.githubusercontent.com/${{ github.repository }}/main"
          
          # ç”Ÿæˆå¤–éƒ¨é…ç½®è¦†å†™
          if [ -d "processed_configs/external" ]; then
            echo "Generating external overwrites..."
            python src/overwrite_generator.py \
              --input processed_configs/external \
              --output overwrite \
              --types main bypass smart \
              --repo-url "$REPO_URL" \
              --source external \
              --verbose
          fi
          
          # ç”Ÿæˆæœ¬åœ°é…ç½®è¦†å†™
          if [ -d "processed_configs/local" ] && [ "$(find processed_configs/local -name '*.yaml' | wc -l)" -gt 0 ]; then
            echo "Generating local overwrites..."
            python src/overwrite_generator.py \
              --input processed_configs/local \
              --output overwrite \
              --types main bypass smart \
              --repo-url "$REPO_URL" \
              --source local \
              --verbose
          fi
          
          echo "âœ… Generated files:"
          ls -la overwrite/

      - name: Generate README for overwrite directory
        run: |
          cat > overwrite/README.md << 'EOF'
          # OpenClash è¦†å†™é…ç½®æ–‡ä»¶
          
          æœ¬ç›®å½•åŒ…å«è‡ªåŠ¨ç”Ÿæˆçš„ OpenClash è¦†å†™é…ç½®æ–‡ä»¶ã€‚
          
          ## æ–‡ä»¶å‘½åè§„åˆ™
          - `Overwrite-external-*`: æ¥è‡ªå¤–éƒ¨ä»“åº“(HenryChiao/mihomo_yamls)çš„é…ç½®
          - `Overwrite-local-*`: æ¥è‡ªæœ¬ä»“åº“ cleaner_config/ ç›®å½•çš„æœ¬åœ°é…ç½®
          - `-main.conf`: ä¸»è·¯ç”±æ ‡å‡†æ¨¡å¼(Url-test)
          - `-bypass.conf`: æ—è·¯ç”±æ¨¡å¼(éœ€è®¾ç½® EN_DNS)
          - `-smart.conf`: Smartæ™ºèƒ½æ¨¡å¼
          
          ## ä½¿ç”¨æ–¹æ³•
          
          1. **ä¸‹è½½è¦†å†™æ–‡ä»¶**: ç›´æŽ¥ç‚¹å‡»éœ€è¦çš„ `.conf` æ–‡ä»¶ï¼Œç‚¹å‡»å³ä¸Šè§’ "Raw" èŽ·å–åŽŸå§‹é“¾æŽ¥
          2. **åœ¨ OpenClash ä¸­ä½¿ç”¨**:
             - è¿›å…¥ OpenClash æ’ä»¶è®¾ç½®
             - æ‰¾åˆ° "è¦†å†™è®¾ç½®" -> "è‡ªå®šä¹‰è¦†å†™"
             - ç²˜è´´æ–‡ä»¶ URL æˆ–ä¸Šä¼ æ–‡ä»¶
          3. **è®¾ç½®çŽ¯å¢ƒå˜é‡**:
             - å•è®¢é˜…: `EN_KEY=https://your-sub-url`
             - å¤šè®¢é˜…: `EN_KEY1=https://sub1`, `EN_KEY2=https://sub2`...
             - æ—è·¯ç”±æ¨¡å¼é¢å¤–éœ€è¦: `EN_DNS=223.5.5.5`
          
          ## è‡ªåŠ¨æ›´æ–°
          
          æœ¬ç›®å½•æ–‡ä»¶æ¯å¤©è‡ªåŠ¨ä»Žä¸Šæ¸¸åŒæ­¥å¹¶é‡æ–°ç”Ÿæˆï¼Œå¦‚éœ€ä¿®æ”¹è¯·ç¼–è¾‘:
          - å¤–éƒ¨é…ç½®: å‘ [HenryChiao/mihomo_yamls](https://github.com/HenryChiao/mihomo_yamls) æäº¤ PR
          - æœ¬åœ°é…ç½®: ä¿®æ”¹æœ¬ä»“åº“çš„ `cleaner_config/` ç›®å½•
          
          EOF
          
          echo "âœ… README generated"

      - name: Commit and Push Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ·»åŠ æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶
          git add processed_configs/ overwrite/ -f
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            git commit -m "ðŸ¤– Auto-build: $(date +'%Y-%m-%d %H:%M:%S')
            
            - Sync external configs from HenryChiao/mihomo_yamls
            - Process local configs from cleaner_config/
            - Generate overwrite files"
            git push
            echo "âœ… Changes pushed to repository"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "overwrite" ]; then
            count=$(ls overwrite/*.conf 2>/dev/null | wc -l)
            echo "- âœ… Generated $count overwrite files" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Generated Files:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            ls -1 overwrite/*.conf 2>/dev/null | head -20 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ No files generated" >> $GITHUB_STEP_SUMMARY
          fi
