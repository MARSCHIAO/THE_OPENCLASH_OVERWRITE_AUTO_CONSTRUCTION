name: Build OpenClash Configs

on:
  # å®šæ—¶è§¦å‘ - æ¯å¤©å‡Œæ™¨2ç‚¹ (UTC)
  schedule:
    - cron: '0 2 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # ä»£ç æ¨é€è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'templates/**'
      - 'config.yaml'
      - '.github/workflows/build.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Sync upstream configs
        run: |
          python src/config_generator.py --sync
      
      - name: Generate config files
        run: |
          python src/config_generator.py --type all
      
      - name: Generate file checksums
        run: |
          cd output
          sha256sum *.conf > SHA256SUMS
          cd ..
      
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.date.outputs.date }}
          release_name: Release ${{ steps.date.outputs.date }}
          body: |
            ## OpenClash è¦†å†™é…ç½®æ–‡ä»¶
            
            è‡ªåŠ¨ç”Ÿæˆäº: ${{ steps.date.outputs.date }}
            
            ### ğŸ“¦ åŒ…å«çš„é…ç½®æ–‡ä»¶
            
            - `Overwrite-main.conf` - ä¸»è·¯ç”± Url-test æ¨¡å¼
            - `Overwrite-main-noipv6.conf` - ä¸»è·¯ç”±æ— IPv6 Url-test
            - `Overwrite-main-smart.conf` - ä¸»è·¯ç”± Smart æ™ºèƒ½æ¨¡å¼  
            - `Overwrite-main-smart-lgbm.conf` - ä¸»è·¯ç”± Smart-LGBM æ¨¡å¼
            - `Overwrite-bypass.conf` - æ—è·¯ç”± Url-test æ¨¡å¼
            - `Overwrite-bypass-smart.conf` - æ—è·¯ç”± Smart æ¨¡å¼
            
            ### ğŸš€ ä½¿ç”¨æ–¹æ³•
            
            1. å¤åˆ¶å¯¹åº”é…ç½®æ–‡ä»¶çš„ Raw é“¾æ¥
            2. åœ¨ OpenClash ä¸­æ·»åŠ è¦†å†™æ¨¡å—
            3. è®¾ç½®ç¯å¢ƒå˜é‡: `EN_KEY=ä½ çš„æœºåœºè®¢é˜…é“¾æ¥`
            4. æ—è·¯ç”±ç”¨æˆ·é¢å¤–è®¾ç½®: `EN_DNS=ä½ çš„DNSæœåŠ¡å™¨`
            
            ### ğŸ“ æ›´æ–°æ—¥å¿—
            
            - è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸é…ç½®æº
            - ç”Ÿæˆæ‰€æœ‰ç±»å‹çš„è¦†å†™é…ç½®
            - æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§
            
            ### ğŸ”— ç›¸å…³é“¾æ¥
            
            - [é¡¹ç›®æ–‡æ¡£](https://github.com/${{ github.repository }})
            - [ä½¿ç”¨æ•™ç¨‹](https://github.com/${{ github.repository }}/blob/main/README.md)
            
          draft: false
          prerelease: false
      
      - name: Upload Release Assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./output/Overwrite-main.conf
          asset_name: Overwrite-main.conf
          asset_content_type: text/plain
      
      - name: Upload more assets
        run: |
          for file in output/*.conf; do
            filename=$(basename "$file")
            echo "Uploading $filename..."
            
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: text/plain" \
              --data-binary @"$file" \
              "${{ steps.create_release.outputs.upload_url }}?name=$filename"
          done
      
      - name: Upload checksums
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./output/SHA256SUMS
          asset_name: SHA256SUMS
          asset_content_type: text/plain
      
      - name: Commit generated files
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add output/
          git commit -m "ğŸ¤– Auto-generated configs - ${{ steps.date.outputs.date }}" || echo "No changes to commit"
          git push
